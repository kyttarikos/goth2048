<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2048 — for denise</title>
<style>
/* ===== Fonts ===== */
@font-face {
  font-family: 'UnifrakturCook';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/unifrakturcook/v24/IurA6Yli8YOdcoky-0PTTdkm56n05Xwy1oM.woff2) format('woff2');
  unicode-range: U+0000-00FF;
}

/* ===== Color variables ===== */
:root{
  --bg-start: #000000;
  --bg-mid: #000000;
  --darkfuschia: #390021;
  --darkred: #2b0000;
  --fuschia: #ff2fa6;
  --accent: #b90a0a;
  --panel: rgba(255,255,255,0.03);
  --lyric-duration: 120s; /* slow */
}

/* ===== Page background gradient ===== */
html,body{
  height:100%;
  margin:0;
  background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-mid) 48%, var(--darkfuschia) 78%, var(--darkred) 100%);
  color:#fff;
  font-family: "Times New Roman", Times, serif;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
}

/* ===== Lyrics area: left, center, right ===== */
.bg-lyrics{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}
.lyric-stripe{
  position:absolute;
  top:0;
  bottom:0;
  display:flex;
  /* make side stripes stretch so track can be full height */
  align-items:stretch;
  justify-content:center;
  overflow:hidden;
  z-index:0;
  pointer-events:none;
}

/* center and sides layout */
.lyric-stripe.center{ left:10%; right:10%; width:auto; }
.lyric-stripe.left { left:0; width:22%; }
.lyric-stripe.right{ right:0; width:22%; }

/* lyric-track is 200% height and the two blocks each 50% — guarantees seamless looping */
.lyric-track{
  width:100%;
  height:200%;
  display:block;           /* vertical stacking */
  box-sizing:border-box;
  will-change: transform;
}

/* each duplicate block is half the track height */
.lyric-block{
  display:block;
  height:50%;
  padding: 16px 10px;
  box-sizing:border-box;
  font-family: 'UnifrakturCook', "Times New Roman", serif;
  font-size:28px;
  line-height:1.18;      /* tighter spacing */
  text-align:center;
  opacity:0.14;
  white-space:pre-wrap;
  text-shadow: 0 2px 6px rgba(0,0,0,0.6);
  overflow:hidden;
}

/* line spacing and alternating colors */
.lyric-line{ display:block; margin:2px 0; padding:0; }
.lyric-line:nth-child(odd) { color: var(--accent); }
.lyric-line:nth-child(even){ color: var(--fuschia); }

/* ===== Scrolling keyframes ===== */
@keyframes scrollUp   { from { transform: translateY(0%); } to { transform: translateY(-50%); } }
@keyframes scrollDown { from { transform: translateY(-50%); } to { transform: translateY(0%); } }

/* start positions set so all tracks begin immediately and loop smoothly */
.lyric-stripe.left  .lyric-track,
.lyric-stripe.right .lyric-track {
  transform: translateY(0%);
  animation: scrollUp var(--lyric-duration) linear infinite;
}
.lyric-stripe.center .lyric-track {
  transform: translateY(-50%);
  animation: scrollDown var(--lyric-duration) linear infinite;
}

/* ===== Game UI and tiles ===== */
.container{ width:560px; max-width:96vw; z-index:2; }
.header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:14px; }
.title{ font-family: 'UnifrakturCook', "Times New Roman", serif; color:var(--accent); font-size:34px; margin:0; }
.sub{ font-size:12px; opacity:0.9; }

.controls{ display:flex; gap:8px; align-items:center; }
.button{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:white; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
.score{ background:var(--panel); padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); text-align:center; min-width:84px; }

.panel{ background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.45)); padding:18px; border-radius:12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); position:relative; }

.grid{ width:100%; aspect-ratio:1/1; background:rgba(255,255,255,0.02); border-radius:8px; padding:12px; box-sizing:border-box; position:relative; overflow:hidden; }
.cells{ position:absolute; inset:12px; display:grid; grid-template-columns: repeat(4,1fr); grid-template-rows: repeat(4,1fr); gap:12px; z-index:0; }
.cell{ background: rgba(255,255,255,0.02); border-radius:8px; }

.tiles{ position:absolute; inset:12px; z-index:2; pointer-events:none; }
.tile{
  position:absolute; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700;
  color:#fff; box-sizing:border-box; padding:6px; text-align:center;
  transition: transform 160ms cubic-bezier(.2,.9,.2,1), left 160ms cubic-bezier(.2,.9,.2,1), top 160ms cubic-bezier(.2,.9,.2,1);
  will-change: transform, left, top; user-select:none;
  border:1px solid rgba(0,0,0,0.25); box-shadow:0 6px 18px rgba(0,0,0,0.55);
  font-family: 'UnifrakturCook', "Times New Roman", serif; font-size:36px;
}
.tile.v16 { font-size:32px; } .tile.v32 { font-size:30px; } .tile.v64 { font-size:28px; }
.tile.v128 { font-size:26px; } .tile.v256 { font-size:24px; } .tile.v512 { font-size:22px; }
.tile.v1024{ font-size:20px; } .tile.v2048{ font-size:18px; }

.tile.new { animation: pop 180ms ease; }
@keyframes pop{ 0%{ transform: scale(0.2); } 60%{ transform: scale(1.08);} 100%{ transform: scale(1);} }
.tile.merged { animation: pulse 220ms ease; }
@keyframes pulse{ 0%{ transform: scale(1);} 50%{ transform: scale(1.12);} 100%{ transform: scale(1);} }

/* Reds (dark -> vibrant) */
.tile.v2   { background:#120202; }
.tile.v4   { background:#200303; }
.tile.v8   { background:#3b0303; }
.tile.v16  { background:#5a0505; }
.tile.v32  { background:#8a0b0b; }
.tile.v64  { background:#b90a0a; }

/* Fuschia range (dark -> vibrant) */
.tile.v128 { background:#6a0038; color:#fff; }
.tile.v256 { background:#9f135f; color:#fff; }
.tile.v512 { background:#c21f7e; color:#fff; }
.tile.v1024{ background:#e02a93; color:#12000a; }
.tile.v2048{ background:#ff2fa6; color:#12000a; }

.overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.56), rgba(0,0,0,0.78)); z-index:10; border-radius:12px; color:white; font-size:28px; text-align:center; padding:22px; }
.hidden{ display:none; } .small{ font-size:14px; opacity:0.9; margin-top:8px; }
.note{ margin-top:12px; text-align:center; font-size:13px; opacity:0.95; }
.credit{ margin-top:6px; font-family: 'UnifrakturCook', "Times New Roman", serif; color:var(--accent); font-size:14px; }

@media (max-width:520px){
  .title{ font-size:26px; }
  .lyric-block{ font-size:18px; }
  .lyric-stripe.left, .lyric-stripe.right{ display:none; }
}
</style>
</head>
<body>

<!-- ===== Lyrics: left, center, right (each track has two identical blocks stacked) ===== -->
<div class="bg-lyrics" aria-hidden="true">

  <!-- LEFT (moves up) -->
  <div class="lyric-stripe left" aria-hidden="true">
    <div class="lyric-track" role="presentation">
      <div class="lyric-block" aria-hidden="true">
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are ever gonna scar me,</span>
        <span class="lyric-line">for all the ghosts that are never gonna catch me.</span>
        <span class="lyric-line">If I fall...</span>
        <span class="lyric-line">If I fall down...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are never gonna...</span>
      </div>

      <div class="lyric-block" aria-hidden="true">
        <!-- duplicate -->
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <!-- ...repeat same lines for seamless loop... -->
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are ever gonna scar me,</span>
        <span class="lyric-line">for all the ghosts that are never gonna catch me.</span>
        <span class="lyric-line">If I fall...</span>
        <span class="lyric-line">If I fall down...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna...</span>
      </div>
    </div>
  </div>

  <!-- CENTER (moves down) -->
  <div class="lyric-stripe center" aria-hidden="true">
    <div class="lyric-track" role="presentation">
      <div class="lyric-block" aria-hidden="true">
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are ever gonna scar me,</span>
        <span class="lyric-line">for all the ghosts that are never gonna catch me.</span>
        <span class="lyric-line">If I fall...</span>
        <span class="lyric-line">If I fall down...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are never gonna...</span>
      </div>

      <div class="lyric-block" aria-hidden="true">
        <!-- duplicate -->
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <!-- ...repeat same lines... -->
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna...</span>
      </div>
    </div>
  </div>

  <!-- RIGHT (moves up) -->
  <div class="lyric-stripe right" aria-hidden="true">
    <div class="lyric-track" role="presentation">
      <div class="lyric-block" aria-hidden="true">
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are ever gonna scar me,</span>
        <span class="lyric-line">for all the ghosts that are never gonna catch me.</span>
        <span class="lyric-line">If I fall...</span>
        <span class="lyric-line">If I fall down...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are never gonna...</span>
      </div>

      <div class="lyric-block" aria-hidden="true">
        <!-- duplicate -->
        <span class="lyric-line">I never said I'd lie in wait forever...</span>
        <span class="lyric-line">If I died, we'd be together, now.</span>
        <span class="lyric-line">I can't always just forget her.</span>
        <span class="lyric-line">But she could try...</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever, ever...</span>
        <span class="lyric-line">Ever get the feeling that you're never all alone?</span>
        <span class="lyric-line">And I remember now.</span>
        <span class="lyric-line">At the top of my lungs</span>
        <span class="lyric-line">in my arms, she dies...</span>
        <span class="lyric-line">she dies!</span>
        <span class="lyric-line">At the end of the world,</span>
        <span class="lyric-line">or the last thing I see</span>
        <span class="lyric-line">you are never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the things that you never ever told me,</span>
        <span class="lyric-line">and all the smiles that are ever gonna haunt me—</span>
        <span class="lyric-line">Never coming home,</span>
        <span class="lyric-line">never coming home—</span>
        <span class="lyric-line">Could I?</span>
        <span class="lyric-line">Should I?</span>
        <span class="lyric-line">And all the wounds that are never gonna...</span>
      </div>
    </div>
  </div>

</div>

<!-- ===== Game UI ===== -->
<div class="container" role="application" aria-label="2048 game">
  <div class="header">
    <div>
      <h1 class="title">2048 &lt;3<br>for denise. ily &lt;3 - i.m.</h1>
    </div>
    <div class="controls">
      <div class="score" aria-live="polite">Score<br><strong id="score">0</strong></div>
      <button class="button" id="newGameBtn" aria-label="New Game">New Game</button>
    </div>
  </div>

  <div class="panel">
    <div class="grid" id="grid" tabindex="0">
      <div class="cells" id="cells"></div>
      <div class="tiles" id="tiles"></div>

      <div class="overlay hidden" id="gameOverOverlay">Game Over<br><div class="small">Press New Game to try again</div></div>
      <div class="overlay hidden" id="winOverlay">You Win!<br><div class="small">Keep going or start new game</div></div>
    </div>
    
    <div class="note">this is a game that you just suddenly started to love as you watched me play again and again. you tried it at first, now it gets you addicted. just like how you made me so addicted to you... well, i just want to say, that i love you forever. i will keep loving you even after the sun dies. a new sun always comes up, whenever you smile. the new sun shines, and it makes my empty body glow in joy, made by you. you make me the most loved man in the world, and i'm really happy that you get to be in my life every single day... i really love you so much, you god damned dork. i'll stay with you for as long as you want me to. my future spouse. &lt;33<br>- truly yours, isaac :)</div>
  </div>
</div>

<script>
/* 2048 game logic & animations (unchanged) */
const SIZE = 4;
const gridEl = document.getElementById('grid');
const cellsEl = document.getElementById('cells');
const tilesEl = document.getElementById('tiles');
const scoreEl = document.getElementById('score');
const newBtn = document.getElementById('newGameBtn');
const gameOverOverlay = document.getElementById('gameOverOverlay');
const winOverlay = document.getElementById('winOverlay');

let board = [];
let score = 0;
let tileIdCounter = 1;
let tileMap = {};
let animating = false;

function buildCells(){ cellsEl.innerHTML=''; for(let i=0;i<SIZE*SIZE;i++){ const d=document.createElement('div'); d.className='cell'; cellsEl.appendChild(d); } }
buildCells();
function emptyBoard(){ board = Array.from({length:SIZE}, ()=> Array(SIZE).fill(0)); }
function cloneBoard(b){ return b.map(r=>r.slice()); }
function randInt(n){ return Math.floor(Math.random()*n); }

function rotateLeft(b){ const n=SIZE, nb=Array.from({length:n}, ()=> Array(n).fill(0)); for(let r=0;r<n;r++) for(let c=0;c<n;c++) nb[n-1-c][r] = b[r][c]; return nb; }
function rotateRight(b){ const n=SIZE, nb=Array.from({length:n}, ()=> Array(n).fill(0)); for(let r=0;r<n;r++) for(let c=0;c<n;c++) nb[c][n-1-r] = b[r][c]; return nb; }
function rotate180(b){ const n=SIZE, nb=Array.from({length:n}, ()=> Array(n).fill(0)); for(let r=0;r<n;r++) for(let c=0;c<n;c++) nb[n-1-r][n-1-c] = b[r][c]; return nb; }
function rotatedToOriginal(rr, rc, rotation){ const n=SIZE; if(rotation==='none') return {r:rr,c:rc}; if(rotation==='left') return {r: rc, c: n-1-rr}; if(rotation==='right') return {r: n-1-rc, c: rr}; if(rotation==='180') return {r: n-1-rr, c: n-1-rc}; }

function moveLeftDetailed(b){
  const n=SIZE; let moved=false, gained=0; const newBoard = Array.from({length:n}, ()=> Array(n).fill(0)); const mappings=[];
  for(let r=0;r<n;r++){
    const sources=[];
    for(let c=0;c<n;c++) if(b[r][c]!==0) sources.push({v:b[r][c], r, c});
    if(sources.length===0) continue;
    const out=[]; let i=0;
    while(i < sources.length){
      if(i+1 < sources.length && sources[i].v === sources[i+1].v){
        const newV = sources[i].v * 2;
        out.push({v:newV, mergedFrom:[sources[i], sources[i+1]]});
        gained += newV; i += 2;
      } else {
        out.push({v: sources[i].v, mergedFrom:[sources[i]]}); i += 1;
      }
    }
    for(let c=0;c<out.length;c++){
      newBoard[r][c] = out[c].v;
      for(const src of out[c].mergedFrom){
        mappings.push({fromR:src.r, fromC:src.c, toR:r, toC:c, merged: out[c].mergedFrom.length>1, newValue: out[c].v});
      }
    }
    for(let c=0;c<n;c++) if(newBoard[r][c] !== b[r][c]) moved=true;
  }
  return {moved, board:newBoard, gained, mappings};
}

function move(dir){
  let rotated, rotation;
  if(dir==='left'){ rotated = cloneBoard(board); rotation='none'; }
  else if(dir==='right'){ rotated = rotate180(board); rotation='180'; }
  else if(dir==='up'){ rotated = rotateLeft(board); rotation='left'; }
  else if(dir==='down'){ rotated = rotateRight(board); rotation='right'; }
  else return {moved:false};
  const res = moveLeftDetailed(rotated);
  if(!res.moved) return {moved:false};
  let final;
  if(rotation==='none') final=res.board;
  else if(rotation==='180') final=rotate180(res.board);
  else if(rotation==='left') final=rotateRight(res.board);
  else final=rotateLeft(res.board);
  const mapped = res.mappings.map(m=>{
    const s = rotatedToOriginal(m.fromR,m.fromC,rotation);
    const d = rotatedToOriginal(m.toR,m.toC,rotation);
    return {fromR:s.r, fromC:s.c, toR:d.r, toC:d.c, merged:m.merged, newValue:m.newValue};
  });
  return {moved:true, board:final, gained:res.gained, mappings:mapped};
}

function cellRect(r,c){ const rect = cellsEl.getBoundingClientRect(); const cellW = rect.width / SIZE; const cellH = rect.height / SIZE; return {left: c*cellW, top: r*cellH, w:cellW, h:cellH}; }

function createTileDOM(value, r, c, opts={}) {
  const el = document.createElement('div');
  const id = 'tile' + (tileIdCounter++);
  el.className = 'tile v' + value + (opts.new? ' new':'');
  el.dataset.id = id; el.dataset.value = value; el.textContent = value;
  tilesEl.appendChild(el);
  tileMap[id] = {el, r, c, v:value};
  const pos = cellRect(r,c);
  el.style.width = pos.w + 'px';
  el.style.height = pos.h + 'px';
  el.style.lineHeight = (pos.h - 12) + 'px';
  el.style.left = pos.left + 'px';
  el.style.top = pos.top + 'px';
  return id;
}
function clearTiles(){ tilesEl.innerHTML = ''; tileMap = {}; tileIdCounter = 1; }
function renderBoardInitial(){ clearTiles(); for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(board[r][c]) createTileDOM(board[r][c], r, c, {new:false}); }

function spawnRandomTile(pop=true){
  const empties=[]; for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(board[r][c]===0) empties.push({r,c});
  if(!empties.length) return null;
  const pick = empties[randInt(empties.length)];
  const val = Math.random() < 0.9 ? 2 : 4;
  board[pick.r][pick.c] = val;
  const id = createTileDOM(val, pick.r, pick.c, {new: pop});
  return id;
}

function layoutAllTiles(){
  const rect = cellsEl.getBoundingClientRect();
  const cellW = rect.width / SIZE, cellH = rect.height / SIZE;
  for(const id in tileMap){
    const t = tileMap[id];
    if(!t || !t.el) continue;
    t.el.style.width = cellW + 'px';
    t.el.style.height = cellH + 'px';
    t.el.style.lineHeight = (cellH - 12) + 'px';
    const pos = cellRect(t.r,t.c);
    t.el.style.left = pos.left + 'px';
    t.el.style.top = pos.top + 'px';
  }
}

async function animateMoveUsingMappings(mappings, finalBoard){
  animating = true;
  const coordToIds = {};
  for(const id in tileMap){ const t = tileMap[id]; coordToIds[`${t.r},${t.c}`] = id; }
  for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(board[r][c] && !coordToIds[`${r},${c}`]) {
    const id = createTileDOM(board[r][c], r, c, {new:false});
    coordToIds[`${r},${c}`] = id;
  }
  const destMap = {};
  for(const m of mappings){
    const fromKey = `${m.fromR},${m.fromC}`;
    const srcId = coordToIds[fromKey];
    if(!srcId) continue;
    const destKey = `${m.toR},${m.toC}`;
    if(!destMap[destKey]) destMap[destKey] = [];
    destMap[destKey].push({id: srcId, newValue: m.newValue, merged: m.merged});
    tileMap[srcId].r = m.toR; tileMap[srcId].c = m.toC;
  }
  layoutAllTiles();
  await new Promise(r=>setTimeout(r, 200));
  for(const destKey in destMap){
    const list = destMap[destKey];
    if(list.length > 1){
      const [rStr, cStr] = destKey.split(','); const r = parseInt(rStr), c = parseInt(cStr);
      for(const s of list){ if(tileMap[s.id] && tileMap[s.id].el){ tileMap[s.id].el.remove(); delete tileMap[s.id]; } }
      const id = createTileDOM(finalBoard[r][c], r, c, {new:false});
      tileMap[id].el.classList.add('merged');
      setTimeout(()=>{ tileMap[id] && tileMap[id].el.classList.remove('merged'); }, 260);
    }
  }
  for(const destKey in destMap){
    const list = destMap[destKey];
    if(list.length === 1){
      const s = list[0]; const t = tileMap[s.id];
      if(t){
        const parts = destKey.split(','); const r = parseInt(parts[0]), c = parseInt(parts[1]);
        const finalVal = finalBoard[r][c];
        if(t.v !== finalVal){
          t.v = finalVal; t.el.dataset.value = finalVal; t.el.className = 'tile v' + finalVal;
          t.el.classList.add('merged');
          setTimeout(()=>{ t.el && t.el.classList.remove('merged'); }, 260);
        } else {
          t.el.className = 'tile v' + t.v;
        }
        t.r = r; t.c = c;
      }
    }
  }
  for(const id in tileMap){
    const t = tileMap[id];
    const v = finalBoard[t.r] && finalBoard[t.r][t.c] ? finalBoard[t.r][t.c] : 0;
    if(v === 0){ t.el.remove(); delete tileMap[id]; }
  }
  layoutAllTiles();
  animating = false;
}

async function tryMove(dir){
  if(animating) return;
  const res = move(dir);
  if(!res.moved) return;
  const finalBoard = res.board;
  if(Object.keys(tileMap).length === 0) renderBoardInitial();
  await animateMoveUsingMappings(res.mappings, finalBoard);
  board = finalBoard;
  score += res.gained; scoreEl.textContent = score;
  spawnRandomTile(true);
  if(board.some(r=>r.some(v=>v>=2048))){ winOverlay.classList.remove('hidden'); setTimeout(()=>winOverlay.classList.add('hidden'), 1400); }
  if(!canMove(board)) gameOverOverlay.classList.remove('hidden');
}

function canMove(b){ for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++){ if(b[r][c]===0) return true; if(c+1<SIZE && b[r][c]===b[r][c+1]) return true; if(r+1<SIZE && b[r][c]===b[r+1][c]) return true; } return false; }

const keyMap = {'ArrowLeft':'left','ArrowRight':'right','ArrowUp':'up','ArrowDown':'down','a':'left','A':'left','d':'right','D':'right','w':'up','W':'up','s':'down','S':'down'};
document.addEventListener('keydown',(e)=>{ if(keyMap[e.key]){ e.preventDefault(); tryMove(keyMap[e.key]); } });

let touchStartX=0,touchStartY=0;
gridEl.addEventListener('touchstart',(e)=>{ if(e.touches.length>1) return; touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; },{passive:true});
gridEl.addEventListener('touchend',(e)=>{ if(!touchStartX && !touchStartY) return; const dx=e.changedTouches[0].clientX-touchStartX; const dy=e.changedTouches[0].clientY-touchStartY; const absX=Math.abs(dx), absY=Math.abs(dy); const threshold=20; if(Math.max(absX,absY)<threshold){ touchStartX=touchStartY=0; return; } if(absX>absY) tryMove(dx>0?'right':'left'); else tryMove(dy>0?'down':'up'); touchStartX=touchStartY=0; });

function newGame(){ emptyBoard(); clearTiles(); score=0; scoreEl.textContent=score; gameOverOverlay.classList.add('hidden'); winOverlay.classList.add('hidden'); spawnRandomTile(true); spawnRandomTile(true); layoutAllTiles(); }
newBtn.addEventListener('click', newGame);

window.addEventListener('resize', ()=> layoutAllTiles());

/* start */
emptyBoard(); spawnRandomTile(true); spawnRandomTile(true); layoutAllTiles();
</script>
</body>
</html>
